---
title: "Sprints 9-11: Coaching Analytics, Recruiting Impact & Operational Hardening"
type: feat
date: 2026-02-06
reviewed: true
review_changes: adjusted transfer_portal_impact (no player_id available), added tenure gap detection algorithm, added DISTINCT ON reminders for ref.teams joins
---

# Sprints 9-11: Coaching Analytics, Recruiting Impact & Operational Hardening

## Current State (Post-Sprint 8)

- **45/60 endpoints loaded** (4 deferred, 1 removed)
- **22 materialized views** in `marts` schema with 5-layer refresh chain
- **14 API views** + **12 RPCs** via PostgREST
- **509 tests** passing
- **~1.7 GB** across all schemas
- Analytics coverage: team profiles, player comparison, game detail, playcalling tendencies

## What's Missing

After 8 sprints of building the data warehouse and analytics layer, three significant analytical gaps remain:

1. **Coaching analytics** — We have `marts.coach_record` (W-L records) but no coaching tenure analysis, school-to-school transitions, or coaching tree visualization data. The `ref.coaches` + `ref.coaches__seasons` tables have rich data that's underutilized.

2. **Recruiting impact analysis** — We have recruiting class composites and player-level recruits, but no analytics connecting recruiting rankings to on-field outcomes (wins, EPA, draft production). This is the #1 question every fan asks: "does recruiting actually translate?"

3. **Transfer portal impact** — We load `recruiting.transfer_portal` (14K rows) but have no analytics showing how portal activity correlates with next-season performance. With the modern transfer era, this is critical context.

4. **Operational gaps** — No CI/CD, no incremental load automation, no data freshness monitoring. The warehouse works but can't maintain itself for the upcoming 2026 season without manual intervention.

---

## Sprint 9: Coaching Analytics & Recruiting ROI

**Goal:** Answer "Who are the best coaches?" and "Does recruiting translate to winning?"

**Deliverables:** 3 new matviews, 2 new API views, ~30 tests

### Task 9.1: `marts.coaching_tenure` (matview)

**File:** `src/schemas/marts/023_coaching_tenure.sql`

**Purpose:** One row per coach-team-tenure span. Tracks coaching stints with aggregate performance, including inherited vs recruited talent.

**Grain:** coach_name + team + tenure_start_season + tenure_end_season

**Source:** `ref.coaches__seasons` JOIN `ref.coaches` JOIN `marts.team_season_summary` JOIN `marts.recruiting_class`

**Columns:**
```
first_name, last_name, team, tenure_start, tenure_end, seasons_count,
total_games, total_wins, total_losses, win_pct,
conf_wins, conf_losses, conf_win_pct,
best_season_wins, worst_season_wins,
avg_sp_rating, peak_sp_rating,
avg_recruiting_rank, best_recruiting_rank,
inherited_talent_rank,    -- recruiting rank in their first season (prior coach's class)
year3_talent_rank,        -- recruiting rank in their 3rd season (their own classes)
talent_improvement,       -- inherited - year3 (positive = improved)
bowl_games, bowl_wins,
is_active                 -- still coaching at this school
```

**Tenure Gap Detection Algorithm:**
```sql
-- Detect tenure boundaries using window function gap detection
WITH ordered AS (
    SELECT first_name, last_name, school AS team, year,
           year - LAG(year) OVER (
               PARTITION BY first_name, last_name, school ORDER BY year
           ) AS gap
    FROM ref.coaches__seasons cs
    JOIN ref.coaches c ON cs._dlt_parent_id = c._dlt_id
),
tenure_groups AS (
    SELECT *, SUM(CASE WHEN gap IS NULL OR gap > 1 THEN 1 ELSE 0 END)
        OVER (PARTITION BY first_name, last_name, team ORDER BY year) AS tenure_id
    FROM ordered
)
-- Each tenure_id represents a contiguous coaching stint
```

**Key Design Decisions:**
- Tenure boundaries detected by consecutive seasons at same school (gap > 1 year = new tenure)
- "Inherited talent" = recruiting rank in coach's first year (previous coach's recruits)
- "Own talent" = recruiting rank in 3rd year (when their full recruiting classes are on the roster)
- Bowl game detection via `season_type = 'postseason'` in games table
- Known issue: 4 coach name collisions exist (different people, same name) — tenure detection handles this via team+year context

**Indexes:**
- UNIQUE on `(first_name, last_name, team, tenure_start)`
- `(team, tenure_start)` — team coaching history queries
- `(win_pct DESC)` — leaderboard queries
- `(seasons_count DESC, win_pct DESC)` — longevity + success queries

**Estimated rows:** ~3,000-5,000

**Acceptance criteria:**
- [ ] Each coaching tenure is a contiguous run of seasons at one school
- [ ] Active coaches have `is_active = true` and `tenure_end = current season`
- [ ] Win pct between 0 and 1
- [ ] Known coaches (Saban, Dabo, etc.) appear with reasonable records

---

### Task 9.2: `marts.recruiting_roi` (matview)

**File:** `src/schemas/marts/024_recruiting_roi.sql`

**Purpose:** Connects recruiting investment to on-field outcomes. One row per team-season with recruiting inputs and performance outputs.

**Grain:** team + season

**Source:** `marts.recruiting_class` JOIN `marts.team_season_summary` JOIN `marts.team_epa_season` JOIN `draft.draft_picks`

**Columns:**
```
team, season, conference,
-- Recruiting inputs (lagged: current roster = classes from 1-4 years ago)
avg_class_rank_4yr,         -- average recruiting rank over prior 4 classes
avg_class_points_4yr,       -- average recruiting points over prior 4 classes
total_blue_chips_4yr,       -- 4/5-star recruits in prior 4 classes
blue_chip_ratio,            -- blue_chips / total_recruits over 4 years

-- On-field outputs (current season)
wins, losses, win_pct,
sp_rating, sp_rank,
epa_per_play, success_rate,

-- Draft output (current season seniors drafted)
players_drafted,
draft_picks_value,          -- sum of (260 - overall_pick) for draft capital proxy

-- ROI metrics
wins_over_expected,         -- actual wins - expected wins based on recruiting rank
epa_over_expected,          -- actual EPA - expected EPA based on talent
recruiting_efficiency,      -- wins / avg_class_rank_4yr (higher = more efficient)

-- Percentiles
win_pct_pctl, epa_pctl, recruiting_efficiency_pctl
```

**Key Design Decisions:**
- 4-year rolling average for recruiting (matches scholarship cycle)
- "Expected" values computed via linear regression proxy: median win_pct/EPA for teams with similar recruiting rank
- Blue chip ratio = (4-star + 5-star) / total_recruits — the BCR is the best single predictor of CFP appearances
- Draft capital uses `(260 - pick_number)` as a simple value proxy

**Indexes:**
- UNIQUE on `(team, season)`
- `(season, recruiting_efficiency DESC)` — efficiency leaderboard
- `(season, blue_chip_ratio DESC)` — BCR leaderboard
- `(conference, season)` — conference-level queries

**Estimated rows:** ~3,500-4,000

**Acceptance criteria:**
- [ ] 4yr rolling average populated for seasons >= 2004 (where 4 prior years exist)
- [ ] Blue chip ratio between 0 and 1
- [ ] Known blue blood programs (Alabama, Ohio State, Georgia) have high BCRs
- [ ] wins_over_expected spans negative to positive range
- [ ] Percentiles between 0 and 1

---

### Task 9.3: `api.coaching_history` (API view)

**File:** `src/schemas/api/015_coaching_history.sql`

**Purpose:** Coaching history for a team, with tenure performance summaries and recruiting impact. Consumed by team detail pages.

**Source:** `marts.coaching_tenure` JOIN `ref.teams`

**Grain:** One row per coaching tenure

**PostgREST usage:**
- `/api/coaching_history?team=eq.Alabama&order=tenure_start.desc` — team's coaching history
- `/api/coaching_history?last_name=eq.Saban` — all of a coach's stops
- `/api/coaching_history?is_active=eq.true&order=win_pct.desc` — active coach leaderboard

---

### Task 9.4: `api.recruiting_roi` (API view)

**File:** `src/schemas/api/016_recruiting_roi.sql`

**Purpose:** Team-season recruiting ROI with percentile rankings. Consumed by team analytics pages.

**Source:** `marts.recruiting_roi`

**PostgREST usage:**
- `/api/recruiting_roi?team=eq.Texas&order=season.desc` — team's recruiting ROI history
- `/api/recruiting_roi?season=eq.2024&order=recruiting_efficiency.desc` — season efficiency leaderboard
- `/api/recruiting_roi?season=eq.2024&conference=eq.SEC` — conference filter

---

### Task 9.5: Update refresh chain

**File:** `src/schemas/functions/refresh_all_marts.sql` + `scripts/refresh_marts.py`

- Add `coaching_tenure` to Layer 2 (depends on `team_season_summary`, `recruiting_class` from Layer 1)
- Add `recruiting_roi` to Layer 2 (depends on `team_season_summary`, `team_epa_season`, `recruiting_class` from Layer 1)
- Update MARTS_VIEWS list in refresh script

**Total matviews after Sprint 9: 24**

---

### Task 9.6: Tests

**File:** `tests/test_coaching_recruiting_analytics.py`

**~30 tests:**

```
class TestCoachingTenure:
    - test_tenure_is_contiguous: no gaps within a tenure
    - test_active_coaches_current_season: is_active coaches have recent tenure_end
    - test_win_pct_range: all between 0 and 1
    - test_known_coaches: Saban at Alabama appears with > 150 wins
    - test_no_duplicate_tenures: unique on (name, team, start)
    - test_inherited_vs_own_talent: talent_improvement is calculated correctly
    - test_bowl_counts: bowl_games >= bowl_wins
    - test_seasons_count_matches: seasons_count = tenure_end - tenure_start + 1

class TestRecruitingROI:
    - test_one_row_per_team_season: no duplicates
    - test_rolling_avg_populated: avg_class_rank_4yr not null for recent seasons
    - test_blue_chip_ratio_range: 0 to 1
    - test_known_blue_bloods_high_bcr: Alabama, Ohio State BCR > 0.5
    - test_wins_over_expected_distribution: spans negative and positive
    - test_efficiency_percentiles: between 0 and 1
    - test_draft_picks_non_negative: players_drafted >= 0
    - test_conference_populated: conference not null for FBS teams

class TestCoachingHistoryAPI:
    - test_view_exists
    - test_returns_rows
    - test_filter_by_team
    - test_filter_by_coach
    - test_active_coaches_filter
    - test_columns_match_contract

class TestRecruitingROI_API:
    - test_view_exists
    - test_returns_rows
    - test_filter_by_season
    - test_filter_by_conference
    - test_one_row_per_team_season
    - test_columns_match_contract
```

### Task 9.7: Update schema contract

**File:** `docs/SCHEMA_CONTRACT.md`

- Add 2 new matviews to marts section
- Add 2 new API views to cfb-app consumer section
- Update mart count (22 → 24)

---

## Sprint 10: Transfer Portal Impact & Conference Realignment Analytics

**Goal:** Answer "How does the portal affect teams?" and "How do conferences compare across eras?"

**Deliverables:** 3 new matviews, 2 new API views, 1 new RPC, ~25 tests

### Task 10.1: `marts.transfer_portal_impact` (matview)

**File:** `src/schemas/marts/025_transfer_portal_impact.sql`

**Purpose:** Connect transfer portal activity to team performance changes. Track transfers in/out and correlate with next-season improvement.

**Grain:** team + season

**Source:** `recruiting.transfer_portal` JOIN `marts.team_season_summary` JOIN `core.roster`

**Columns:**
```
team, season, conference,
-- Portal activity
transfers_in, transfers_out, net_transfers,
avg_incoming_stars,             -- average star rating of incoming transfers
avg_incoming_rating,            -- average recruit rating of incoming transfers
incoming_high_stars,            -- count of 4/5-star incoming transfers

-- Prior-year context
prior_season_wins, prior_season_sp_rating,

-- Current season results
current_wins, current_sp_rating,

-- Impact metrics
win_delta,                      -- current_wins - prior_wins
sp_delta,                       -- current_sp - prior_sp
portal_dependency,              -- transfers_in / total_roster_size
win_delta_per_transfer_in,      -- efficiency metric

-- Percentiles
net_transfers_pctl, win_delta_pctl, portal_dependency_pctl
```

**Key Design Decisions:**
- Transfer portal data available from ~2021+, so limited historical depth
- **No player_id in transfer_portal table** — cannot match to prior-year stats. Use star ratings and recruit ratings as quality proxies instead.
- Portal dependency = transfers_in / total_roster_size (from `core.roster`)
- Only count FBS-to-FBS transfers for meaningful comparisons (filter by `origin` and `destination` being FBS schools)
- `transfers_in` = players whose `destination` = this team; `transfers_out` = players whose `origin` = this team

**Estimated rows:** ~700-1,000 (FBS teams × portal-era seasons)

---

### Task 10.2: `marts.conference_comparison` (matview)

**File:** `src/schemas/marts/026_conference_comparison.sql`

**Purpose:** Conference-level aggregate metrics per season for conference vs conference analysis. Enables "SEC vs Big Ten" comparisons.

**Grain:** conference + season

**Source:** `marts.team_season_summary` JOIN `marts.team_epa_season` JOIN `marts.recruiting_class` JOIN `ref.teams`

**Columns:**
```
conference, season,
-- Size
member_count,

-- Performance
avg_wins, avg_sp_rating, median_sp_rating,
best_team, best_team_sp,
worst_team, worst_team_sp,
std_dev_sp,                    -- parity measure

-- EPA
avg_epa_per_play, avg_success_rate,

-- Recruiting
avg_recruiting_rank, total_blue_chips,
avg_blue_chip_ratio,

-- Strength
non_conf_win_pct,              -- how the conference fares vs other conferences
ranked_team_count,             -- teams in top 25

-- Percentiles across conferences
avg_sp_pctl, avg_epa_pctl, avg_recruiting_pctl, non_conf_win_pct_pctl
```

**Key Design Decisions:**
- **CRITICAL:** Use `DISTINCT ON (school)` when joining `ref.teams` — 35 duplicate school names cause fanout without it:
  ```sql
  SELECT DISTINCT ON (school) school, conference
  FROM ref.teams ORDER BY school, classification NULLS LAST
  ```
- Non-conference win pct = wins vs non-conference opponents / total non-conference games
- Only FBS conferences (exclude FCS, Independents handled separately)
- Ranked team count uses AP/Coaches poll when available, SP+ rank <= 25 as fallback

**Estimated rows:** ~300-400 (12-15 conferences × 20+ seasons)

---

### Task 10.3: `marts.conference_head_to_head` (matview)

**File:** `src/schemas/marts/027_conference_head_to_head.sql`

**Purpose:** Conference vs conference head-to-head records by season. Enables "SEC is 47-12 against the Big 12 this year" analysis.

**Grain:** conference_1 + conference_2 + season

**Source:** `core.games` JOIN `ref.teams` (twice, for home and away)

**Columns:**
```
conference_1, conference_2, season,
total_games,
conf1_wins, conf2_wins, ties,
conf1_win_pct,
avg_point_diff,                -- positive = conf1 advantage
avg_spread_diff,               -- how games compared to spread
```

**Estimated rows:** ~2,000-3,000 (conference pairs × seasons)

---

### Task 10.4: `api.transfer_portal_impact` (API view)

**File:** `src/schemas/api/017_transfer_portal_impact.sql`

**PostgREST usage:**
- `/api/transfer_portal_impact?team=eq.Colorado&order=season.desc`
- `/api/transfer_portal_impact?season=eq.2024&order=win_delta.desc` — biggest portal improvers

---

### Task 10.5: `api.conference_comparison` (API view)

**File:** `src/schemas/api/018_conference_comparison.sql`

**Source:** `marts.conference_comparison` JOIN `marts.conference_head_to_head`

This view combines conference stats with head-to-head records, so you can ask "how does the SEC perform overall AND how do they do against the Big Ten specifically?"

**PostgREST usage:**
- `/api/conference_comparison?season=eq.2024&order=avg_sp_pctl.desc` — conference power rankings
- `/api/conference_comparison?conference=eq.SEC` — SEC across all seasons

---

### Task 10.6: `get_conference_head_to_head` RPC

**File:** `src/schemas/public/010_conference_h2h_function.sql`

**Signature:** `get_conference_head_to_head(p_conf1 text, p_conf2 text, p_season_start int DEFAULT NULL, p_season_end int DEFAULT NULL)`

**Returns:** Season-by-season head-to-head breakdown between two conferences with cumulative totals.

---

### Task 10.7: Update refresh chain + tests

- Add 3 matviews to refresh chain (Layer 2 for all — depend on Layer 1 marts)
- **~25 tests** in `tests/test_portal_conference_analytics.py`
- Update schema contract

**Total matviews after Sprint 10: 27**
**Total API views after Sprint 10: 18**

---

## Sprint 11: Operational Hardening & Season Readiness

**Goal:** Prepare the warehouse for automated 2026 season maintenance. CI/CD, incremental loading, data freshness monitoring.

**Deliverables:** GitHub Actions CI, incremental load script, data freshness RPC, monitoring views

### Task 11.1: GitHub Actions CI Pipeline

**File:** `.github/workflows/ci.yml`

Run on every push and PR to `main`:

```yaml
jobs:
  lint:
    - ruff check .
    - ruff format --check .
  test:
    - pytest -q --tb=short
    # Tests hit live Supabase (integration tests)
    # Use repository secrets for SUPABASE_DB_URL and CFBD_API_KEY
```

**Acceptance criteria:**
- [ ] CI runs on push to main and on PRs
- [ ] Lint + format + test all pass
- [ ] Secrets configured via GitHub repository settings
- [ ] Badge added to README

---

### Task 11.2: Incremental Season Load Script

**File:** `scripts/load_season.py`

A single entry point for loading/refreshing data for a specific season:

```python
def load_season(season: int, sources: list[str] | None = None) -> dict:
    """
    Load or refresh all data for a given season.

    1. Load reference data (if stale)
    2. Load game/play data for the season
    3. Load stats for the season
    4. Load ratings for the season
    5. Refresh affected materialized views
    6. Return summary (rows loaded, duration, errors)
    """
```

**Key Features:**
- Smart dependency ordering (reference → games → plays → stats → ratings → marts refresh)
- Dry-run mode for API call count estimation
- Progress logging to stdout and optional `pipeline_runs` table
- Partial source selection (`--sources games,stats,ratings`)
- Rate limit awareness (check remaining budget before starting)

**Acceptance criteria:**
- [ ] `python scripts/load_season.py --season 2025 --dry-run` reports expected API calls
- [ ] `python scripts/load_season.py --season 2025` loads data and refreshes marts
- [ ] Logs summary to stdout with row counts per source
- [ ] Respects rate limit budget

---

### Task 11.3: Data Freshness Monitoring

**File:** `src/schemas/marts/028_data_freshness.sql` (matview) + `src/schemas/public/011_data_freshness_function.sql`

#### `marts.data_freshness` (matview)

Track when each key table was last updated, how many rows it has, and whether it's stale.

**Columns:**
```
schema_name, table_name, row_count,
last_load_timestamp,          -- from _dlt_loads
latest_season,                -- MAX(season) in the table
days_since_load,
is_stale,                     -- true if > 7 days since load during season
expected_refresh_frequency    -- 'daily' | 'weekly' | 'seasonal' | 'static'
```

#### `get_data_freshness()` RPC

Returns current freshness status for all tracked tables. Useful for cfb-app to show a "data last updated" indicator.

---

### Task 11.4: Supabase Cron for Weekly Refresh

**File:** `src/schemas/functions/cron_weekly_refresh.sql`

Use `pg_cron` (available on Supabase Pro) to schedule weekly matview refreshes:

```sql
SELECT cron.schedule(
    'weekly-marts-refresh',
    '0 6 * * 1',  -- Monday 6am UTC
    $$SELECT marts.refresh_all()$$
);
```

**Note:** This only refreshes matviews — actual data loading still requires the Python pipeline. This ensures marts stay fresh even if new data was loaded ad-hoc.

**Acceptance criteria:**
- [ ] Cron job created (or documented as requiring Pro plan)
- [ ] Can be enabled/disabled via simple SQL
- [ ] Doesn't conflict with manual refresh

---

### Task 11.5: README Overhaul

**File:** `README.md`

Replace the current README with a comprehensive project README covering:
- Project overview and architecture diagram
- Quick start (setup, credentials, first pipeline run)
- Available analytics (mart inventory with descriptions)
- API surface reference (view list with PostgREST examples)
- Development workflow (tests, linting, contributing)
- Downstream consumers section
- CI badge

---

### Task 11.6: Tests + Schema Contract Update

- **~15 tests** for new operational features
- Update schema contract with freshness RPC
- Update MEMORY.md with sprint 9-11 learnings

**Total matviews after Sprint 11: 28**
**Total API views after Sprint 11: 18**
**Total RPCs after Sprint 11: 13**

---

## Summary

| Sprint | Theme | New Matviews | New API Views | New RPCs | New Tests |
|--------|-------|-------------|--------------|----------|-----------|
| 9 | Coaching & Recruiting ROI | 2 | 2 | 0 | ~30 |
| 10 | Portal Impact & Conference Analysis | 3 | 2 | 1 | ~25 |
| 11 | Operational Hardening | 1 | 0 | 1 | ~15 |
| **Total** | | **6** | **4** | **2** | **~70** |

**Post Sprint 11 Totals:**
- 28 materialized views
- 18 API views
- 14 RPCs
- ~580 tests
- CI/CD pipeline
- Incremental load automation
- Data freshness monitoring

---

## Dependency Graph

```
Sprint 9 (Coaching + Recruiting ROI)
  ├── 9.1 coaching_tenure matview
  ├── 9.2 recruiting_roi matview
  ├── 9.3 api.coaching_history (depends on 9.1)
  ├── 9.4 api.recruiting_roi (depends on 9.2)
  ├── 9.5 refresh chain update (depends on 9.1, 9.2)
  ├── 9.6 tests (depends on all above)
  └── 9.7 schema contract (depends on all above)

Sprint 10 (Portal + Conference) — can start after Sprint 9
  ├── 10.1 transfer_portal_impact matview
  ├── 10.2 conference_comparison matview
  ├── 10.3 conference_head_to_head matview
  ├── 10.4 api.transfer_portal_impact (depends on 10.1)
  ├── 10.5 api.conference_comparison (depends on 10.2, 10.3)
  ├── 10.6 get_conference_head_to_head RPC (depends on 10.3)
  └── 10.7 refresh + tests + contract

Sprint 11 (Operational) — can start in parallel with Sprint 10
  ├── 11.1 GitHub Actions CI
  ├── 11.2 Incremental load script
  ├── 11.3 Data freshness monitoring
  ├── 11.4 Cron scheduling
  ├── 11.5 README overhaul
  └── 11.6 Tests + contract
```

---

## Risk Analysis

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Coach name collisions in tenure detection | Medium | Medium | Known issue (4 collisions). Use first_name + last_name + team + start_year for uniqueness. |
| Transfer portal data limited to ~2021+ | Certain | Low | Document limitation. Only analyze portal-era seasons. |
| Recruiting ROI lagged correlation is imprecise | Medium | Low | 4-year rolling average is standard industry approach. Document assumptions. |
| Supabase Pro required for pg_cron | Medium | Low | Document as optional. Manual refresh remains available. |
| CI secrets management | Low | Medium | Use GitHub encrypted secrets. Never commit credentials. |
| Conference realignment makes historical comparisons fuzzy | Medium | Low | Use `ref.eras` for era-aware grouping. Document team conference at time of game, not current conference. |
